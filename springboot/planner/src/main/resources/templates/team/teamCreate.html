<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
	<meta charset="UTF-8"/>
	<title>그룹 생성</title>
	<style>
	* {
		margin:0;
		padding:0;
	}
	</style>
</head>
<body>
<!-- th:action으로 해야 csrf 자동생성됨. 그냥 action쓰면 자동생성 안됨. -->
<form th:action="@{/team/create}" method="post" id="team_form" enctype="multipart/form-data" onsubmit="return false">
<table>
	<tr>
		<td><label for="team_name">그룹 이름</label></td>
		<td>
			<input type="text" name="team_name" id="team_name" maxlength="50" placeholder="2글자 이상 50글자 이하" required>
			<button type="button" id="overlap_btn">중복검사</button>
			<p id="overlap" style="display:none;"></p>
		</td>
	</tr>
	<tr>
		<td><label for="team_explain">그룹 소개</label></td>
		<td><textarea name="team_explain" id="team_explain" cols="42" rows="7" maxlength="333"></textarea></td>
	</tr>
	<tr>
		<td><label for="team_image">그룹 이미지</label></td>
		<td><input type="file" name="team_image" id="team_image" accept=".jpg, .jpeg, .png, .gif, .wbmp, .bmp, .tif, .tiff"></td>
	</tr>
	<tr>
		<td></td>
		<td>
			<span style="font-size:0.8em; color:gray;">이미지는 100x100 사이즈를 권장합니다.<br>움직이는 이미지는 지원하지 않습니다.</span>
		</td>
	</tr>
	<tr>
		<td colspan="2" align="right">
			<button type="reset">리셋</button>
			<button type="button" id="submit_btn">생성</button>
		</td>
	</tr>
</table>
</form>
	
<script>
	const team_form = document.getElementById("team_form");
	const team_name = document.getElementById("team_name");
	const overlap_btn = document.getElementById("overlap_btn");
	const overlap = document.getElementById("overlap");
	const submit_btn = document.getElementById("submit_btn");
	const img = document.getElementById('team_image');
	const fileFormat = /(jpg|jpeg|png|bmp|wbmp|gif|tif|tiff)/; // 허용할 이미지 확장자
 	const maxSize = 2*1024*1024;	// 최대 크기 2MB
 	const pass_msg = "사용 가능한 그룹 이름입니다.";
 	const overlap_msg = "이미 사용중인 그룹 이름입니다.";

 	// 그룹 이름 중복 검사
 	overlap_btn.addEventListener("click", function(){
 		team_name.value = team_name.value.trim();
 		if(team_name.value.length < 2){
 			alert("그룹 이름은 2글자 이상 입력해주세요");
 			return;
 		}
 		fetch("/team/overlap?team_name="+team_name.value)
 			.then(response => response.text()) // response 객체의 값을 꺼내고
 			.then(result => {				// 다음 then에서 사용. K:V면 text()말고 json() 사용
		 		overlap.style.display = 'block'
 				if(result == 1){ // 중복 아님
			 		overlap.style.color = 'blue'
			 		overlap.innerText = pass_msg;
 				}else{ // 중복임
			 		overlap.style.color = 'red'
			 		overlap.innerText = overlap_msg;
 				}
 			});
 	});

 	// 그룹 이름 바뀌면 중복검사 초기화
 	team_name.addEventListener("keydown", function(){
 		overlap.style.display = 'none';
 		overlap.innerText = '';
 	});
 	
 	// submit 버튼
 	submit_btn.addEventListener("click", function(){
 		if(overlap.innerText == pass_msg){ // 중복 검사 통과된 상태면
 	 		if(img.files[0] != null){ // 이미지 파일 있으면 검사
	 			let filename = img.value.split('.');
	 			if(filename[filename.length-1].match(fileFormat) == null){
	 				alert("지원하지 않는 형식의 파일입니다.");
	 				return;
	 			}
	 			if(img.files[0].size > maxSize){
	 				alert('2MB 이하의 이미지를 사용해 주세요.');
	 				return;
	 			}
 	 		}
 	 		team_form.submit();
 		}else{
 			alert("그룹 이름 중복 검사를 해주세요.");
 		}
 	});
</script>

<th:block th:if="${msg}">
<input type="hidden" id="msg" th:value="${msg}">
<script>
	alert(document.getElementById("msg").value);
</script>
</th:block>
</body>
</html>